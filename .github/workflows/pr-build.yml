name: PR Preview Build

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed 

jobs:
  pr-build:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: Setup JDK 
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 17

      - name: Compute PR Image Tag
        id: pr-tag
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG="pr-${PR_NUMBER}-${SHORT_SHA}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
      - name: Build & Push PR Image (Jib)
        run: |
          IMAGE="ghcr.io/mut-ink/mut-ink-test:${{ steps.pr-tag.outputs.IMAGE_TAG }}"
          mvn -B package -Pghcr-push -Dmaven.test.skip=true -Djib.to.image="$IMAGE" jib:build \
            -Djib.to.auth.username="${{ github.actor }}" \
            -Djib.to.auth.password="${{ secrets.GHCR_PAT }}"

  pr-cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete PR Image Tags
        env:
          GH_TOKEN: ${{ secrets.GHCR_PAT }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          gh api -H "Accept: application/vnd.github+json" \
          /orgs/mut-ink/packages/container/mut-ink-test/versions \
          | jq -c '.[]' | while read -r version; do
            VERSION_ID=$(echo "$version" | jq -r '.id')
            TAGS=$(echo "$version" \
              | jq -r '.metadata.container.tags[]')

            for TAG in $TAGS; do
              if echo "$TAG" | grep -q "pr-${PR_NUMBER}-"; then
                echo "Deleting PR tag $TAG from version $VERSION_ID"

                gh api \
                  -X DELETE \
                  "/orgs/mut-ink/packages/container/mut-ink-test/versions/${VERSION_ID}/tags/${TAG}"
              fi
            done
          done
