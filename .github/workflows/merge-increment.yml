name: Build and Push to GHCR on Merge

on:
  push:
    branches:
      - master  # or 'master'

permissions:
  contents: write      # required to push version bump commits
  packages: write      # required to push to GHCR

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # we’ll re-auth with PAT
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GHCR_PAT }}@github.com/${{ github.repository }}.git

      - name: Bump patch version
        id: bump
        run: |
          # Get current version
          current=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          base=${current%.*}
          patch=${current##*.}
          new="${base}.$((patch + 1))"

          echo "current=$current" >> $GITHUB_OUTPUT
          echo "new=$new" >> $GITHUB_OUTPUT
          echo "Bumping version: $current → $new"

          mvn versions:set -DnewVersion=$new -DgenerateBackupPoms=false
          git commit -am "chore: bump version to $new"
          git push origin HEAD:master

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image with Jib
        run: mvn -B clean package -Pghcr-push -Djib.to.tags="${{ steps.bump.outputs.new }},latest"
        env:
          GITHUB_TOKEN: ${{ secrets.GHCR_PAT }}

      - name: Verify published image
        run: |
          echo "✅ Image successfully pushed:"
          echo "ghcr.io/mut-ink/mut-ink-backend:${{ steps.bump.outputs.new }}"
          echo "ghcr.io/mut-ink/mut-ink-backend:latest"

