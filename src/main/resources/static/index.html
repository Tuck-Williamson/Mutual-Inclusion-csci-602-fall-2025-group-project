<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>MutInc - Mutual Inclusion</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Preact / HTM -->
    <script src="https://unpkg.com/preact@10.5.15/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/preact@10.5.15/hooks/dist/hooks.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.0/dist/htm.umd.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


    <!-- Import Map -->
    <script type="importmap">
        {
          "imports": {
            "lists": "/js/lists.js",
            "account": "/js/account.js",
            "list-detail": "/js/list_detail.js",
            "modal": "/js/modal.js",
            "websocket": "/js/web_socket_list_manager.js",
            "user-pill": "/js/user_pill.js",
            "notification_banner": "/js/notification_banner.js",
            "sharing": "/js/sharing.js"
          }
        }
    </script>

    <style>
        .modal {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-400 to-purple-600 text-gray-900">


<div id="banner-root" class="w-full"></div>
<div id="app" class="w-full">
</div>

<!--WebSocket init script-->
<script type="module">
    import { initWebSocket } from "websocket";
    import { showNotification } from "notification_banner";

    const {h, render} = preact;
    const html = htm.bind(h);

    initWebSocket()
        .then(console.log("WebSocket connected successfully!"))
        .catch(err => {
            console.error("Failed to connect to WebSocket:", err);
            // render(
            //     html`
            //         <${Notification}
            //                 message="Problem connecting to the server. Please refresh the page after some time or try again later."
            //                 type="error"
            //         />`,
            //     document.body
            // );
            showNotification("Problem connecting to the server. Please refresh the page after some time or try again later.");
        });

</script>

<!-- APP SCRIPT -->
<script type="module">

    const { h, render } = preact;
    const {useState, useEffect} = preactHooks;

    const html = htm.bind(h);

    import ListsPage from "lists";
    import AccountPage from "account";
    import ListDetailPage from "list-detail";
    import UserPill from "user-pill";
    import {showNotification} from "notification_banner";
    import {ShareList} from "sharing";


    const getQueryParams = () => {
        const params = new URLSearchParams(window.location.search);
        return Object.fromEntries(params.entries());
    };

    const App = () => {
        const [page, setPage] = useState("lists");
        const [currentList, setCurrentList] = useState(null);
        const {error, note, v, share} = getQueryParams();

        // FIXED NAVIGATION (unwrap wrapped list object)
        const navigate = (p, data = null) => {
            if (data && data.list) {
                setCurrentList(data.list);  // unwrap
            } else {
                setCurrentList(data);
            }
            setPage(p);
            let validPages = ["lists", "account", "list-detail", "share"];

            const state = {page: validPages.includes(p) ? p : "lists", list: data};
            window.history.pushState(state, '', window.location.pathname + '?p=' + p + (data?.list ? `&v=${data.list.id}` : ''));
        };

        let content;
        if (page === "lists") {
            content = html`<${ListsPage} navigate=${navigate} />`;
        }
        if (page === "account") {
            content = html`<${AccountPage} navigate=${navigate} />`;
        }
        if (page === "share" && currentList) {
            content = html`<${ShareList} list=${currentList} navigate=${navigate} />`;
        }
        if (page === "list-detail" && currentList) {
            content = html`<${ListDetailPage} list=${currentList} navigate=${navigate} />`;
        }


        useEffect(() => {
            async function fetchListForPage(listId, page = "share") {
                const response = await fetch(`/list/${listId}`);
                if (!response.ok) {
                    showNotification("Error fetching list: " + response.statusText);
                    return;
                }
                const list = await response.json();
                navigate(page, {list: list});
            }

            if (share && v) {
                // Todo show share page.
                fetchListForPage(v, "share");
            } else if (v) {
                // Todo show list page.
                fetchListForPage(v, "list-detail");
            }

            window.onpopstate = (event) => {
                if (event.state?.page && event.state?.list) {
                    navigate(event.state.page, event.state.list);
                } else {
                    navigate("lists");
                }
            };

            // This is needed to remove the query params from the URL after navigation.
            // Otherwise, the user will continue to get redirected to the same page with the params.
            window.history.pushState({}, '', window.location.pathname);
        }, []);

        return html`
            <div class="fixed top-4 right-4 z-50">
              <${UserPill} navigate=${navigate} />
            </div>
            <div class="mx-auto max-w-4xl bg-white shadow-2xl rounded-2xl
                        mt-16 p-6 sm:p-8 lg:p-12">
                ${content}
            </div>
            ${error && showNotification(error) && window.history.pushState({}, '', window.location.pathname)}
            ${note && showNotification(note, "notification") && window.history.pushState({}, '', window.location.pathname)}
        `;
    };

    render(html`<${App} />`, document.getElementById("app"));
    
</script>

</body>
</html>
