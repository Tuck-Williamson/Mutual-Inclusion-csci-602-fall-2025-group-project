<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>MutInc - Mutual Inclusion</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Preact / HTM -->
    <script src="https://unpkg.com/preact@10.5.15/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/preact@10.5.15/hooks/dist/hooks.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.0/dist/htm.umd.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


    <!-- Import Map -->
    <script type="importmap">
        {
          "imports": {
            "lists": "/js/lists.js",
            "account": "/js/account.js",
            "list-detail": "/js/list_detail.js",
            "modal": "/js/modal.js",
            "websocket": "/js/web_socket_list_manager.js",
            "user-pill": "/js/user_pill.js"
          }
        }
    </script>

    <style>
        .modal {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-400 to-purple-600 text-gray-900">

<!-- USERNAME PILL -->
<!-- <div class="fixed top-4 right-4 z-50"> -->
<!--     <button -->
<!--             id="username-pill" -->
<!--             class="px-4 py-1.5 rounded-full shadow-lg bg-blue-600 text-white -->
<!--                text-sm font-semibold -->
<!--                lg:px-6 lg:py-2 lg:text-base -->
<!--                hover:bg-blue-700 transition"> -->
<!--         <i class="fa-solid fa-user mr-2"></i> Username -->
<!--     </button> -->
<!-- </div> -->

<div id="app" class="w-full"></div>

<!--WebSocket init script-->
<script type="module">
    import { initWebSocket } from "websocket";

    // TODO Error UI
    initWebSocket()
        .then(console.log("WebSocket connected successfully!"))
        .catch(err => console.error("Failed to connect to WebSocket:", err));

</script>

<!-- APP SCRIPT -->
<script type="module">
    const { h, render } = preact;
    const { useState } = preactHooks;

    const html = htm.bind(h);

    import ListsPage from "lists";
    import AccountPage from "account";
    import ListDetailPage from "list-detail";
    import UserPill from "user-pill";

    const App = () => {
        const [page, setPage] = useState("lists");
        const [currentList, setCurrentList] = useState(null);

        // FIXED NAVIGATION (unwrap wrapped list object)
        const navigate = (p, data = null) => {
            if (data && data.list) {
                setCurrentList(data.list);  // unwrap
            } else {
                setCurrentList(data);
            }
            setPage(p);
        };

        let content;
        if (page === "lists") {
            content = html`<${ListsPage} navigate=${navigate} />`;
        }
        if (page === "account") {
            content = html`<${AccountPage} navigate=${navigate} />`;
        }
        if (page === "list-detail" && currentList) {
            content = html`<${ListDetailPage} list=${currentList} navigate=${navigate} />`;
        }

        return html`
            <div class="fixed top-4 right-4 z-50">
              <${UserPill} navigate=${navigate} />
            </div>
            <div class="mx-auto max-w-4xl bg-white shadow-2xl rounded-2xl
                        mt-16 p-6 sm:p-8 lg:p-12">
                ${content}
            </div>
        `;
    };

    render(html`<${App} />`, document.getElementById("app"));
</script>

</body>
</html>
